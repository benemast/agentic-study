x-env-file: &env
  env_file:
    - .env

networks:
  web:
    external: false
  internal:
    external: false
  tailscale:
    external: false

volumes:
  postgres_data:
  redis_data:
  letsencrypt:
  tailscale_state:

services:
  # Tailscale VPN for secure private access
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${TAILSCALE_HOSTNAME:-agentic-study}
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - tailscale_state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_ACCEPT_DNS=false
    networks:
      - tailscale
    labels:
      - "traefik.enable=false"
    restart: unless-stopped

  # Traefik reverse proxy with auto SSL
  traefik:
    image: traefik:v3.0
    environment:
      - DOCKER_API_VERSION=1.44
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file.directory=/etc/traefik/dynamic
      - --metrics.prometheus=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addRoutersLabels=true
      - --metrics.prometheus.addServicesLabels=true
      - --metrics.prometheus.buckets=0.1,0.3,1.2,5.0
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.transport.respondingTimeouts.readTimeout=0
      - --entrypoints.websecure.transport.respondingTimeouts.writeTimeout=0
      - --entrypoints.websecure.transport.respondingTimeouts.idleTimeout=300s
      - --serversTransport.forwardingTimeouts.dialTimeout=30s
      - --serversTransport.forwardingTimeouts.responseHeaderTimeout=0
      - --serversTransport.forwardingTimeouts.idleConnTimeout=90s
      - --certificatesresolvers.le.acme.tlschallenge=true
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --api.dashboard=true
      - --accesslog=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_USERS}"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      # Catch all HTTP to HTTPS (*.yourdomain)
      - "traefik.http.routers.http-catchall.rule=HostRegexp(\"{host:.+}\")"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      # traefik Dashboar, API & Metrics
      - "traefik.http.routers.traefik.rule=Host(\"traefik.${DOMAIN}\") && (PathPrefix(\"/dashboard\") || PathPrefix(\"/api\") || PathPrefix(\"/metrics\"))"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=le"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=dashboard-auth@docker,security-headers@file"
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    <<: *env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
      - tailscale
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - internal
      - tailscale
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "PING"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    <<: *env
    environment:
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - ENVIRONMENT=production
      - DEBUG=False
      - OPENAI_API_KEY_INSTITUTE=${OPENAI_API_KEY_INSTITUTE}
      - OPENAI_API_KEY_PERSONAL=${OPENAI_API_KEY_PERSONAL}
      - OPENAI_API_URL=https://api.openai.com/v1/chat/completions
      - LLM_MODEL=${LLM_MODEL:-gpt-4}
      - USE_STREAM=true
      - MAX_CONTEXT_MESSAGES=10
      - DEFAULT_MAX_TOKENS=1024
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=production
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY}
      - LANGSMITH_ENABLED=${LANGSMITH_ENABLED:-false}
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - LANGSMITH_ENDPOINT=https://eu.api.smith.langchain.com
      - LANGSMITH_PROJECT=${LANGSMITH_PROJECT}
      - SESSION_TIMEOUT_MINUTES=60
      - AUTO_SYNC_INTERVAL_MINUTES=5
      - FRONTEND_URL=https://study.${DOMAIN}
      - CORS_ORIGINS=["https://study.${DOMAIN}", "https://${DOMAIN}"]
    depends_on:
      - postgres
      - redis
    networks:
      - internal
      - web
      - tailscale
    volumes:
      - ./logs/backend:/app/logs
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=agentic-study_web"
      - "traefik.http.routers.api.rule=Host(\"api.${DOMAIN}\")"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=le"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      - "traefik.http.services.api.loadbalancer.sticky.cookie=true"
      - "traefik.http.routers.api.middlewares=security-headers@file,rate-limit@file"
      - "traefik.http.middlewares.redirect-to-https-api.redirectscheme.scheme=https"
      - "traefik.http.routers.api-http.rule=Host(\"api.${DOMAIN}\")"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=redirect-to-https-api"
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: https://api.${DOMAIN}
        VITE_SENTRY_DSN: ${VITE_SENTRY_DSN}
        VITE_SENTRY_ENVIRONMENT: ${VITE_SENTRY_ENVIRONMENT}
        VITE_CONTACT_NAME: ${VITE_CONTACT_NAME}
        VITE_CONTACT_EMAIL: ${VITE_CONTACT_EMAIL}
        VITE_ENABLE_CLARITY: ${VITE_ENABLE_CLARITY}
        VITE_CLARITY_PROJECT_ID: ${VITE_CLARITY_PROJECT_ID}
        VITE_DEBUG: ${VITE_DEBUG}
        VITE_SESSION_TIMEOUT: ${VITE_SESSION_TIMEOUT}
    depends_on:
      - backend
    networks:
      - web
      - tailscale
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=agentic-study_web"
      - "traefik.http.routers.web.rule=Host(\"${DOMAIN}\")"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls.certresolver=le"
      - "traefik.http.services.web.loadbalancer.server.port=80"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.web-http.rule=Host(\"${DOMAIN}\")"
      - "traefik.http.routers.web-http.entrypoints=web"
      - "traefik.http.routers.web-http.middlewares=redirect-to-https"
    restart: unless-stopped

  # pgAdmin (accessible via Tailscale or with auth)
  pgadmin:
    image: dpage/pgadmin4
    <<: *env
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
    depends_on:
      - postgres
    networks:
      - web
      - internal
      - tailscale
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=agentic-study_web"
      - "traefik.http.routers.pgadmin.rule=Host(\"pgadmin.${DOMAIN}\")"
      - "traefik.http.routers.pgadmin.entrypoints=websecure"
      - "traefik.http.routers.pgadmin.tls.certresolver=le"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
      - "traefik.http.middlewares.pgadmin-auth.basicauth.users=${PGADMIN_USERS}"
      - "traefik.http.routers.pgadmin.middlewares=pgadmin-auth@docker"
    restart: unless-stopped
